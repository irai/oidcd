<svg xmlns="http://www.w3.org/2000/svg" width="1500" height="1200" font-family="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace" font-size="14">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="8" refX="10" refY="4" orient="auto">
      <path d="M0,0 L10,4 L0,8 Z" fill="#222"/>
    </marker>
    <style>
      .lane { fill:#f8f9fa; stroke:#bbb; }
      .actor { font-weight:700; }
      .lifeline { stroke:#bbb; stroke-dasharray:6 6; }
      .msg { stroke:#222; marker-end:url(#arrow); }
      .note { fill:#fff8dc; stroke:#e7c678; }
      .box { fill:#eef5ff; stroke:#9bb7f0; }
      .label { fill:#222; }
      .small { font-size:12px; fill:#444; }
    </style>
  </defs>

  <!-- Lanes -->
  <!-- x positions for lanes -->
  <!-- 0: Browser, 1: Web App (BFF), 2: Gateway (OIDC Provider), 3: Upstream IdP (Auth0/Entra), 4: Microservice API -->
  <rect x="40"  y="20" width="240" height="1160" class="lane"/>
  <rect x="320" y="20" width="240" height="1160" class="lane"/>
  <rect x="600" y="20" width="240" height="1160" class="lane"/>
  <rect x="880" y="20" width="280" height="1160" class="lane"/>
  <rect x="1190" y="20" width="260" height="1160" class="lane"/>

  <!-- Actors -->
  <text x="160" y="50" class="actor">Browser</text>
  <text x="440" y="50" class="actor">Web App (BFF client)</text>
  <text x="720" y="50" class="actor">Gateway (OIDC Provider)</text>
  <text x="1020" y="50" class="actor">Upstream IdP (Auth0/Entra)</text>
  <text x="1320" y="50" class="actor">Microservice API</text>

  <!-- Lifelines -->
  <line x1="160" y1="70" x2="160" y2="1170" class="lifeline"/>
  <line x1="440" y1="70" x2="440" y2="1170" class="lifeline"/>
  <line x1="720" y1="70" x2="720" y2="1170" class="lifeline"/>
  <line x1="1020" y1="70" x2="1020" y2="1170" class="lifeline"/>
  <line x1="1320" y1="70" x2="1320" y2="1170" class="lifeline"/>

  <!-- Timeline labels -->
  <text x="20" y="95" class="small">t0</text>
  <text x="20" y="210" class="small">t1</text>
  <text x="20" y="330" class="small">t2</text>
  <text x="20" y="480" class="small">t3</text>
  <text x="20" y="640" class="small">t4</text>
  <text x="20" y="790" class="small">t5</text>
  <text x="20" y="980" class="small">t6</text>
  <text x="20" y="1120" class="small">t7</text>

  <!-- 1) User hits a protected page on the Web App -->
  <line x1="160" y1="100" x2="440" y2="100" class="msg"/>
  <text x="200" y="92" class="label">GET /dashboard</text>

  <!-- 2) Web App detects no local session → redirect to Gateway /authorize -->
  <line x1="440" y1="140" x2="720" y2="140" class="msg"/>
  <text x="480" y="132" class="label">302 → /authorize (client_id, scope, PKCE, state, nonce, idp?)</text>

  <line x1="720" y1="170" x2="440" y2="170" class="msg"/>
  <text x="470" y="162" class="label">302 back to browser (Location: gateway)</text>

  <!-- 3) Browser follows redirect to Gateway /authorize -->
  <line x1="160" y1="210" x2="720" y2="210" class="msg"/>
  <text x="260" y="202" class="label">GET /authorize</text>

  <!-- 4) Gateway checks local session -->
  <rect x="640" y="230" width="160" height="30" class="note"/>
  <text x="650" y="250" class="small">Session valid?</text>

  <!-- 5a) If no session → redirect to IdP /authorize -->
  <line x1="720" y1="290" x2="1020" y2="290" class="msg"/>
  <text x="740" y="282" class="label">302 → IdP /authorize (code+PKCE)</text>

  <line x1="1020" y1="320" x2="720" y2="320" class="msg"/>
  <text x="820" y="312" class="label">302 back (Location: IdP)</text>

  <!-- 6) Browser loads IdP login, user authenticates -->
  <line x1="160" y1="360" x2="1020" y2="360" class="msg"/>
  <text x="420" y="352" class="label">GET IdP /authorize (login UI)</text>

  <rect x="940" y="380" width="160" height="42" class="note"/>
  <text x="948" y="398" class="small">User enters creds/MFA</text>
  <text x="948" y="414" class="small">IdP authenticates user</text>

  <!-- 7) IdP redirects user back to Gateway with authorization code -->
  <line x1="1020" y1="440" x2="720" y2="440" class="msg"/>
  <text x="800" y="432" class="label">302 → /callback/entra|auth0?code=...</text>

  <line x1="720" y1="470" x2="160" y2="470" class="msg"/>
  <text x="300" y="462" class="label">302 back (Location: gateway callback)</text>

  <!-- 8) Browser follows to Gateway callback -->
  <line x1="160" y1="510" x2="720" y2="510" class="msg"/>
  <text x="360" y="502" class="label">GET /callback/{idp}?code=...</text>

  <!-- 9) Gateway exchanges code with IdP token endpoint (back-channel) -->
  <line x1="720" y1="550" x2="1020" y2="550" class="msg"/>
  <text x="760" y="542" class="label">POST /token (code → ID token)</text>

  <line x1="1020" y1="580" x2="720" y2="580" class="msg"/>
  <text x="780" y="572" class="label">ID token + user info</text>

  <!-- 10) Gateway creates/refreshes local session -->
  <rect x="640" y="600" width="160" height="42" class="note"/>
  <text x="648" y="618" class="small">Create local session</text>
  <text x="648" y="634" class="small">Set cookie gw_session</text>

  <!-- 11) Gateway issues its own authorization code back to Web App -->
  <line x1="720" y1="660" x2="440" y2="660" class="msg"/>
  <text x="510" y="652" class="label">302 → redirect_uri?code=...</text>

  <line x1="440" y1="690" x2="160" y2="690" class="msg"/>
  <text x="240" y="682" class="label">302 to Web App</text>

  <!-- 12) Browser hits Web App redirect_uri with code -->
  <line x1="160" y1="730" x2="440" y2="730" class="msg"/>
  <text x="200" y="722" class="label">GET /callback?code=...</text>

  <!-- 13) Web App (back-channel) exchanges code at Gateway /token -->
  <line x1="440" y1="770" x2="720" y2="770" class="msg"/>
  <text x="490" y="762" class="label">POST /token (code + PKCE) </text>

  <line x1="720" y1="800" x2="440" y2="800" class="msg"/>
  <text x="520" y="792" class="label">Access Token (JWT) + Refresh</text>

  <!-- 14) Web App sets its own session (BFF) -->
  <rect x="360" y="820" width="160" height="42" class="note"/>
  <text x="368" y="838" class="small">Create app session</text>
  <text x="368" y="854" class="small">httpOnly cookie</text>

  <!-- 15) Browser requests protected resource on Web App -->
  <line x1="160" y1="880" x2="440" y2="880" class="msg"/>
  <text x="190" y="872" class="label">GET /dashboard (now authenticated)</text>

  <!-- 16) Web App calls Microservice API with Gateway access token -->
  <line x1="440" y1="920" x2="1320" y2="920" class="msg"/>
  <text x="600" y="912" class="label">GET /api/resource  Authorization: Bearer &lt;AT&gt;</text>

  <!-- 17) Microservice validates JWT against Gateway JWKS -->
  <rect x="1240" y="940" width="160" height="58" class="box"/>
  <text x="1248" y="960" class="small">Validate JWT:</text>
  <text x="1248" y="976" class="small">iss/aud/exp/scope</text>
  <text x="1248" y="992" class="small">JWKS (cache)</text>

  <!-- 18) Microservice returns data to Web App -->
  <line x1="1320" y1="1020" x2="440" y2="1020" class="msg"/>
  <text x="840" y="1012" class="label">200 OK (JSON)</text>

  <!-- 19) Web App renders to Browser -->
  <line x1="440" y1="1060" x2="160" y2="1060" class="msg"/>
  <text x="260" y="1052" class="label">200 OK (HTML/JSON)</text>

  <!-- Alt path: Session reuse -->
  <path d="M705,235 h-20 v-30 h-520 v-20" fill="none" stroke="#888" stroke-dasharray="4 4"/>
  <text x="200" y="210" class="small">If session valid at Gateway, skip IdP</text>

  <!-- Legend -->
  <rect x="60" y="1090" width="1380" height="80" fill="#f3f6ff" stroke="#c9d8ff"/>
  <text x="70" y="1110" class="small">
    Legend: The Web App uses the gateway as its OIDC Provider. If the gateway session (gw_session) is valid, /authorize immediately issues a code. 
    The Web App exchanges the code for an Access Token (JWT) from the gateway and calls the Microservice API with it. The Microservice validates the JWT via JWKS.
  </text>
  <text x="70" y="1130" class="small">
    Upstream IdP (Auth0/Entra) handles the user's actual login UI. The gateway performs back-channel code exchange, creates a local session, and mints first-party tokens.
  </text>
</svg>
